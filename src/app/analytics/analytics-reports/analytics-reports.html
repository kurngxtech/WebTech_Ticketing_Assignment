<div class="analytics-page">
  <!-- Back Button -->
  <button class="back-button" (click)="goBack()" title="Go back">‚Üê Back</button>

  <!-- Main Content -->
  @if (currentEvent && analytics) {
  <div class="analytics-content">
    <!-- Event Header -->
    <div class="event-header animate-fade-in-up" style="animation-delay: 0.1s">
      <h1>{{ currentEvent.title }}</h1>
      @if (currentEvent.img) {
      <img [src]="currentEvent.img" [alt]="currentEvent.title" class="event-image" />
      } @else {
      <div class="event-image-placeholder">Event Image</div>
      }
    </div>

    <!-- Quick Stats Grid -->
    <div class="quick-stats-grid animate-fade-in-up" style="animation-delay: 0.2s">
      <div class="stat-box">
        <p class="stat-label">Best Selling Ticket</p>
        <p class="stat-value">{{ getTopTicketType()?.type || 'N/A' }}</p>
      </div>
      <div class="stat-box">
        <p class="stat-label">Total Revenue</p>
        <p class="stat-value">{{ formatPrice(analytics.totalRevenue) }}</p>
      </div>
      <div class="stat-box">
        <p class="stat-label">Ticket Sold</p>
        <p class="stat-value">{{ analytics.totalTicketsSold }}</p>
      </div>
    </div>

    <!-- Chart Card Section -->
    <div class="chart-card animate-fade-in-up" style="animation-delay: 0.3s">
      <!-- Chart Header -->
      <div class="chart-header">
        <div class="chart-title-area">
          <p class="chart-statement">{{ getStatementText() }}</p>
          <p class="chart-value">{{ getStatementValue() }}</p>
        </div>
        <button class="time-toggle-btn" (click)="toggleTimePeriodMenu($event)" title="Time period">
          @if (!showTimePeriodMenu) {
          <span class="icon">‚ãÆ</span>
          } @else {
          <span class="icon">‚úï</span>
          }
        </button>
      </div>

      <!-- Chart Display with Blur Effect -->
      <div class="chart-display" [class.blur]="showTimePeriodMenu">
        @if (isLoadingChart) {
        <div class="chart-loading">
          <span class="loading-spinner"></span>
          <p>Loading chart data...</p>
        </div>
        } @else if (chartDataPoints.length === 0) {
        <div class="chart-empty">
          <p>No data available for this period</p>
        </div>
        } @else {
        <svg class="line-chart" viewBox="0 0 1000 300" preserveAspectRatio="xMidYMid meet">
          <!-- Grid Lines -->
          <g class="grid">
            @for (i of [0,1,2,3,4]; track i) {
            <line
              [attr.x1]="40"
              [attr.y1]="i * 60 + 30"
              [attr.x2]="960"
              [attr.y2]="i * 60 + 30"
              class="grid-line"
            />
            }
          </g>

          <!-- Chart Line -->
          <polyline [attr.points]="getLinePoints()" class="chart-line" />

          <!-- Data Points with Hover -->
          @for (point of chartDataPoints; track $index; let i = $index) {
          <g
            class="data-point-group"
            (mouseenter)="onChartPointHover(point, $event, i)"
            (mouseleave)="onChartPointLeave()"
          >
            <circle [attr.cx]="point.x" [attr.cy]="point.y" r="8" class="data-point" />
            <circle [attr.cx]="point.x" [attr.cy]="point.y" r="16" class="data-point-hover-area" />
          </g>
          }
        </svg>

        <!-- Tooltip - Fixed at top of chart for visibility -->
        @if (hoveredPoint) {
        <div class="chart-tooltip chart-tooltip-fixed" [style.left.px]="tooltipX">
          <div class="tooltip-header">{{ hoveredPoint.label }}</div>
          <div class="tooltip-content">
            <div class="tooltip-row">
              <span class="tooltip-label">üé´ Tickets Sold:</span>
              <span class="tooltip-value">{{ hoveredPoint.ticketsSold }}</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">üí∞ Revenue:</span>
              <span class="tooltip-value">{{ formatPrice(hoveredPoint.revenue) }}</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">üìã Bookings:</span>
              <span class="tooltip-value">{{ hoveredPoint.bookings }}</span>
            </div>
          </div>
        </div>
        } }

        <!-- Time Period Menu Overlay - Center -->
        @if (showTimePeriodMenu) {
        <div class="time-period-overlay">
          <div class="overlay-content">
            <button class="overlay-close-btn" (click)="closeTimePeriodMenu()" title="Close">
              ‚úï
            </button>
            <p class="overlay-label">Select Time Period</p>
            <div class="period-buttons">
              <button
                class="period-option-btn"
                [class.active]="selectedTimePeriod === 'daily'"
                (click)="selectTimePeriod('daily')"
              >
                Daily
              </button>
              <button
                class="period-option-btn"
                [class.active]="selectedTimePeriod === 'weekly'"
                (click)="selectTimePeriod('weekly')"
              >
                Weekly
              </button>
              <button
                class="period-option-btn"
                [class.active]="selectedTimePeriod === 'monthly'"
                (click)="selectTimePeriod('monthly')"
              >
                Monthly
              </button>
            </div>
          </div>
        </div>
        }
      </div>

      <!-- Legend and Occupancy Section -->
      <div class="chart-footer">
        <!-- Chart Legend (left side) -->
        <div class="chart-legend">
          @for (point of chartDataPoints; track $index; let i = $index) {
          <div
            class="legend-item"
            (mouseenter)="onChartPointHover(point, $event, i)"
            (mouseleave)="onChartPointLeave()"
          >
            <span class="legend-dot"></span>
            <span class="legend-label">{{ point.label }}</span>
          </div>
          }
        </div>

        <!-- Occupancy Box -->
        <div class="occupancy-box">
          <p class="occupancy-label">Occupancy Rate</p>
          <p class="occupancy-value">{{ getOccupancyPercentage() }}%</p>
        </div>
      </div>
    </div>
  </div>
  } @else {
  <div class="empty-state">
    <p>Loading analytics data...</p>
  </div>
  }

  <!-- Print PDF Button -->
  <button class="print-button" (click)="printPDF()" title="Print as PDF">üñ®Ô∏è</button>
</div>
