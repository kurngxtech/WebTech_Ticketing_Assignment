<div class="my-bookings-page" [class.sort-menu-open]="isSortMenuOpen">
   <div class="container-fluid">
      <!-- Header dengan Sort Menu -->
      <div class="page-header">
         <h1 class="page-title">My Bookings</h1>
         <button class="sort-menu-toggle" (click)="toggleSortMenu()" [class.open]="isSortMenuOpen">
            <span class="hamburger-icon" *ngIf="!isSortMenuOpen">‚ò∞</span>
            <span class="close-icon" *ngIf="isSortMenuOpen">‚úï</span>
         </button>
      </div>

      <!-- Backdrop blur effect -->
      <div class="sort-menu-backdrop" [class.active]="isSortMenuOpen" (click)="closeSortMenu()"></div>

      <!-- Sort Menu Overlay -->
      <div class="sort-menu" [class.open]="isSortMenuOpen">
         <div class="sort-menu-content">
            <h3>Filter Bookings</h3>
            
            <button 
               class="sort-item"
               [class.active]="filterStatus === 'all'"
               (click)="setFilter('all')">
               <span class="sort-label">All Bookings</span>
               <span class="sort-count">{{ getTotalBookings() }}</span>
            </button>

            <button 
               class="sort-item confirmed"
               [class.active]="filterStatus === 'confirmed'"
               (click)="setFilter('confirmed')">
               <span class="sort-label">‚úì Confirmed</span>
               <span class="sort-count">{{ getConfirmedCount() }}</span>
            </button>

            <button 
               class="sort-item pending"
               [class.active]="filterStatus === 'pending'"
               (click)="setFilter('pending')">
               <span class="sort-label">‚è≥ Pending</span>
               <span class="sort-count">{{ getPendingCount() }}</span>
            </button>

            <button 
               class="sort-item cancelled"
               [class.active]="filterStatus === 'cancelled'"
               (click)="setFilter('cancelled')">
               <span class="sort-label">‚úï Cancelled</span>
               <span class="sort-count">{{ getCancelledCount() }}</span>
            </button>

            <button 
               class="sort-item waitlist"
               [class.active]="filterStatus === 'waitlist'"
               (click)="setFilter('waitlist')">
               <span class="sort-label">‚≠ê Waitlist</span>
               <span class="sort-count">{{ getWaitlistCount() }}</span>
            </button>
         </div>
      </div>

      <!-- Main Content -->
      @if (isLoading) {
         <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading your bookings...</p>
         </div>
      } @else {
         <!-- Bookings Grid -->
         @if (filterStatus !== 'waitlist') {
            @if (filteredBookings.length === 0) {
               <div class="no-bookings-message">
                  <p>No bookings found for this filter</p>
                  <button class="btn-reset" (click)="setFilter('all')">View All Bookings</button>
               </div>
            }

            <div class="bookings-grid">
               @for (booking of filteredBookings; track booking.id) {
                  <div class="booking-card" [class.active]="selectedBookingId === booking.id" (click)="selectBooking(booking.id)">
                     <!-- Card Header -->
                     <div class="card-header">
                        <div class="card-title-section">
                           <h3 class="event-title">{{ booking.eventTitle }}</h3>
                           <span class="status-badge" [class]="getStatusBadgeClass(booking.status)">{{ booking.status }}</span>
                        </div>
                     </div>

                     <!-- Card Content -->
                     <div class="card-content">
                        <div class="content-left">
                           <div class="booking-info">
                              <div class="info-row">
                                 <span class="info-label">Date:</span>
                                 <span class="info-value">{{ booking.eventDate | date: 'MMM dd, yyyy' }}</span>
                              </div>
                              <div class="info-row">
                                 <span class="info-label">Ticket Type:</span>
                                 <span class="info-value">{{ booking.ticketType }}</span>
                              </div>
                              <div class="info-row">
                                 <span class="info-label">Quantity:</span>
                                 <span class="info-value">{{ booking.quantity }} ticket(s)</span>
                              </div>
                              <div class="info-row price">
                                 <span class="info-label">Total:</span>
                                 <span class="info-value">{{ booking.totalPrice | number }}</span>
                              </div>
                           </div>

                           <!-- Action Buttons -->
                           <div class="card-actions">
                              <button class="btn btn-download" (click)="downloadTicket(booking.id); $event.stopPropagation()" title="Download as PDF">
                                 üì• Download PDF
                              </button>
                              @if (canCancelSelectedBooking && selectedBookingId === booking.id) {
                                 <button class="btn btn-cancel" (click)="cancelBooking(booking.id); $event.stopPropagation()" title="Cancel Booking">
                                    ‚úï Cancel
                                 </button>
                              }
                           </div>
                        </div>

                        <!-- QR Code Section -->
                        <div class="qr-section">
                           @if (bookingQrDataUrls.get(booking.id)) {
                              <div class="qr-code-container">
                                 <img [src]="bookingQrDataUrls.get(booking.id)" alt="QR Code" class="qr-code" />
                              </div>
                           } @else {
                              <div class="qr-placeholder">
                                 <p>No QR</p>
                              </div>
                           }
                        </div>
                     </div>
                  </div>
               }
            </div>
         }

         <!-- Waitlist Section -->
         @if (filterStatus === 'waitlist' || filterStatus === 'all') {
            <div class="waitlist-section">
               <h3 class="waitlist-title">‚≠ê Waitlist Entries ({{ getWaitlistCount() }})</h3>
               
               @if (waitlistEntries.length === 0) {
                  <div class="no-items-message">
                     <p>No waitlist entries</p>
                  </div>
               }

               @if (waitlistEntries.length > 0) {
                  <div class="waitlist-grid">
                     @for (entry of waitlistEntries; track entry.id) {
                        <div class="waitlist-card">
                           <div class="waitlist-header">
                              <h4>{{ dataEventService.getEventById(entry.eventId)?.title || 'Unknown Event' }}</h4>
                              <span class="badge-waitlist">Waiting...</span>
                           </div>
                           <div class="waitlist-info">
                              <p><strong>Ticket Type:</strong> {{ entry.ticketCategoryId }}</p>
                              <p><strong>Quantity:</strong> {{ entry.quantity }}</p>
                           </div>
                        </div>
                     }
                  </div>
               }
            </div>
         }
      }
   </div>
</div>
