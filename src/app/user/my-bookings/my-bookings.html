<div class="my-bookings-page default-bg-color" [class.sort-menu-open]="isSortMenuOpen">
  <div class="container-fluid">
    <!-- Header dengan Sort Menu -->
    <div class="page-header">
      <h1 class="page-title">My Bookings</h1>
      <div class="header-actions">
        <button
          class="btn-refresh me-3"
          (click)="loadBookings(true)"
          [disabled]="isLoading || isCheckingPayment"
          title="Refresh Bookings"
        >
          <svg
            [class.spinning]="isLoading || isCheckingPayment"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
            <path d="M21 3v5h-5" />
          </svg>
          Refresh
        </button>
        <button
          class="sort-menu-toggle"
          (click)="toggleSortMenu()"
          [class.open]="isSortMenuOpen"
          aria-label="Toggle Filter Menu"
        >
          <svg
            class="hamburger-icon"
            *ngIf="!isSortMenuOpen"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
          <svg
            class="close-icon"
            *ngIf="isSortMenuOpen"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Payment Status Message -->
    @if (paymentStatusMessage) {
    <div
      class="payment-status-banner"
      [class.success]="paymentStatusMessage.includes('successful')"
      [class.pending]="paymentStatusMessage.includes('pending')"
      [class.error]="paymentStatusMessage.includes('failed')"
    >
      <span class="status-icon">
        @if (isCheckingPayment) {
        <span class="spinner-border spinner-border-sm me-2"></span>
        }
      </span>
      {{ paymentStatusMessage }}
    </div>
    }

    <!-- Backdrop blur effect -->
    <div class="sort-menu-backdrop" [class.active]="isSortMenuOpen" (click)="closeSortMenu()"></div>

    <!-- Sort Menu Overlay -->
    <div class="sort-menu" [class.open]="isSortMenuOpen">
      <div class="sort-menu-content">
        <h3>Filter Bookings</h3>

        <button
          class="sort-item"
          [class.active]="filterStatus === 'all'"
          (click)="setFilter('all')"
          aria-label="Show All Bookings"
        >
          <span class="sort-label">All Bookings</span>
          <span class="sort-count">{{ getTotalBookings() }}</span>
        </button>

        <button
          class="sort-item confirmed"
          [class.active]="filterStatus === 'confirmed'"
          (click)="setFilter('confirmed')"
        >
          <span class="sort-label"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
            >
              <polyline points="20 6 9 17 4 12" />
            </svg>
            Confirmed</span
          >
          <span class="sort-count">{{ getConfirmedCount() }}</span>
        </button>

        <button
          class="sort-item pending"
          [class.active]="filterStatus === 'pending'"
          (click)="setFilter('pending')"
        >
          <span class="sort-label"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <polyline points="12 6 12 12 16 14" />
            </svg>
            Pending</span
          >
          <span class="sort-count">{{ getPendingCount() }}</span>
        </button>

        <button
          class="sort-item cancelled"
          [class.active]="filterStatus === 'cancelled'"
          (click)="setFilter('cancelled')"
        >
          <span class="sort-label"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <line x1="15" y1="9" x2="9" y2="15" />
              <line x1="9" y1="9" x2="15" y2="15" />
            </svg>
            Cancelled</span
          >
          <span class="sort-count">{{ getCancelledCount() }}</span>
        </button>

        <button
          class="sort-item waitlist"
          [class.active]="filterStatus === 'waitlist'"
          (click)="setFilter('waitlist')"
        >
          <span class="sort-label"
            ><svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
              />
            </svg>
            Waitlist</span
          >
          <span class="sort-count">{{ getWaitlistCount() }}</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading your bookings...</p>
    </div>
    } @else {
    <!-- Bookings Grid -->
    @if (filterStatus !== 'waitlist') { @if (filteredBookings.length === 0) {
    <div class="no-bookings-message">
      <p>No bookings found for this filter</p>
      <button class="btn-reset" (click)="setFilter('all')">View All Bookings</button>
    </div>
    }

    <div class="bookings-grid">
      @for (booking of displayedBookings; track booking.id) {
      <div
        class="booking-card"
        [class.active]="selectedBookingId === booking.id"
        [class.pending-card]="booking.status === 'pending'"
        (click)="selectBooking(booking.id)"
      >
        <!-- Card Header -->
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="event-title">{{ booking.eventTitle }}</h3>
            <span class="status-badge" [class]="getStatusBadgeClass(booking.status)">{{
              booking.status
            }}</span>
          </div>
        </div>

        <!-- Card Content -->
        <div class="card-content">
          <div class="content-left">
            <div class="booking-info">
              <div class="info-row">
                <span class="info-label">Date:</span>
                <span class="info-value">{{ booking.eventDate | date : 'MMM dd, yyyy' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ticket Type:</span>
                <span class="info-value">{{ booking.ticketType }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Quantity:</span>
                <span class="info-value">{{ booking.quantity }} ticket(s)</span>
              </div>
              <div class="info-row price">
                <span class="info-label">Total:</span>
                <span class="info-value">{{ booking.totalPrice | number }}</span>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="card-actions">
              <button
                class="btn btn-download"
                (click)="downloadTicket(booking.id); $event.stopPropagation()"
                title="Download as PDF"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Download PDF
              </button>
              @if (canCancelSelectedBooking && selectedBookingId === booking.id) {
              <button
                class="btn btn-cancel"
                (click)="cancelBooking(booking.id); $event.stopPropagation()"
                title="Cancel Booking"
                [attr.aria-label]="'Cancel booking for ' + booking.eventTitle"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
                Cancel
              </button>
              }
            </div>
          </div>

          <!-- QR Code Section -->
          <div class="qr-section">
            @if (booking.status === 'confirmed' && bookingQrDataUrls.get(booking.id)) {
            <div class="qr-code-container">
              <img
                [src]="bookingQrDataUrls.get(booking.id)"
                [alt]="'QR Code for ' + booking.eventTitle"
                class="qr-code"
                (click)="downloadTicket(booking.id); $event.stopPropagation()"
                title="Click to download as PDF"
              />
            </div>
            } @else if (booking.status === 'pending') {
            <div class="pending-payment-section">
              <div
                class="countdown-timer"
                [class.expiring-soon]="isExpiringSoon(booking.expiresAt)"
              >
                @if (!isExpired(booking.expiresAt)) {
                <svg
                  class="countdown-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg>
                <span class="countdown-text">{{ getCountdownText(booking.expiresAt) }}</span>
                } @else {
                <svg
                  class="countdown-icon warning"
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="#ef4444"
                  stroke-width="2"
                >
                  <path
                    d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"
                  />
                  <line x1="12" y1="9" x2="12" y2="13" />
                  <line x1="12" y1="17" x2="12.01" y2="17" />
                </svg>
                <span class="countdown-text expired">Payment Expired</span>
                }
              </div>
              <p class="pending-text">Complete payment to confirm booking</p>
              @if (!isExpired(booking.expiresAt)) {
              <button
                class="btn btn-continue-payment"
                (click)="continuePayment(booking.id); $event.stopPropagation()"
                title="Complete your payment"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="1" y="4" width="22" height="16" rx="2" />
                  <line x1="1" y1="10" x2="23" y2="10" />
                </svg>
                Complete Payment
              </button>
              }
              <button
                class="btn btn-remove-booking"
                (click)="showRemoveBookingConfirm(booking.id); $event.stopPropagation()"
                title="Remove this pending booking"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="3 6 5 6 21 6" />
                  <path
                    d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                  />
                </svg>
                Remove
              </button>
            </div>
            } @else if (booking.status === 'cancelled') {
            <div class="cancelled-section">
              <p class="cancelled-text">This booking was cancelled</p>
              <button
                class="btn btn-remove-booking"
                (click)="showRemoveBookingConfirm(booking.id); $event.stopPropagation()"
                title="Remove from history"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="3 6 5 6 21 6" />
                  <path
                    d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"
                  />
                </svg>
                Remove
              </button>
            </div>
            }
          </div>
        </div>
      </div>
      }
    </div>

    <!-- View More Button -->
    @if (hasMoreBookings) {
    <div class="view-more-container">
      <button class="btn btn-view-more" (click)="toggleViewMore()">
        View More ({{ filteredBookings.length - displayLimit }} more)
      </button>
    </div>
    } @if (showAllBookings && filteredBookings.length > displayLimit) {
    <div class="view-more-container">
      <button class="btn btn-view-less" (click)="toggleViewMore()">Show Less</button>
    </div>
    } }

    <!-- Waitlist Section -->
    @if (filterStatus === 'waitlist' || filterStatus === 'all') {
    <div class="waitlist-section">
      <h3 class="waitlist-title">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="var(--primary-yellow)"
        >
          <polygon
            points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
          />
        </svg>
        Waitlist Entries ({{ getWaitlistCount() }})
      </h3>

      @if (waitlistEntries.length === 0) {
      <div class="no-items-message">
        <p>No waitlist entries</p>
      </div>
      } @if (waitlistEntries.length > 0) {
      <div class="waitlist-grid">
        @for (entry of waitlistEntries; track entry.id) {
        <div class="waitlist-card">
          <div class="waitlist-header">
            <h4>{{ getEventTitle(entry.eventId) }}</h4>
            <span class="badge-waitlist">Waiting...</span>
          </div>
          <div class="waitlist-info">
            <p><strong>Ticket Type:</strong> {{ entry.ticketCategoryId }}</p>
            <p><strong>Quantity:</strong> {{ entry.quantity }}</p>
          </div>
          <div class="waitlist-actions">
            <button
              class="btn btn-cancel-waitlist"
              (click)="showWaitlistCancelConfirm(entry.id)"
              title="Cancel Waitlist Entry"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
              Cancel Waitlist
            </button>
          </div>
        </div>
        }
      </div>
      }
    </div>
    } }
  </div>
</div>

<!-- Waitlist Cancel Confirmation Modal -->
@if (waitlistCancelConfirmId) {
<div class="confirmation-modal-overlay" (click)="hideWaitlistCancelConfirm()">
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <h3>Cancel Waitlist Entry?</h3>
    <p>Are you sure you want to remove yourself from this waitlist?</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="hideWaitlistCancelConfirm()">No, Keep It</button>
      <button class="btn btn-danger" (click)="confirmCancelWaitlist()">Yes, Cancel</button>
    </div>
  </div>
</div>
}

<!-- Booking Remove Confirmation Modal -->
@if (bookingRemoveConfirmId) {
<div class="confirmation-modal-overlay" (click)="hideRemoveBookingConfirm()">
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <h3>Remove Booking?</h3>
    <p>
      This will permanently remove this booking from your history and free up the seats for other
      users.
    </p>
    <div class="modal-actions">
      <button class="btn btn-secondary" (click)="hideRemoveBookingConfirm()">Cancel</button>
      <button class="btn btn-danger" (click)="confirmRemoveBooking()">Yes, Remove</button>
    </div>
  </div>
</div>
}
