<div class="my-bookings-page">
   <div class="container-fluid w-75">
      <h1 class="page-title">My Bookings</h1>

      <div class="filter-section">
         <button 
            class="filter-btn"
            [class.active]="filterStatus === 'all'"
            (click)="setFilter('all')">
            All Bookings
         </button>
         <button 
            class="filter-btn"
            [class.active]="filterStatus === 'confirmed'"
            (click)="setFilter('confirmed')">
            Confirmed
         </button>
         <button 
            class="filter-btn"
            [class.active]="filterStatus === 'pending'"
            (click)="setFilter('pending')">
            Pending
         </button>
         <button 
            class="filter-btn"
            [class.active]="filterStatus === 'cancelled'"
            (click)="setFilter('cancelled')">
            Cancelled
         </button>
      </div>

      @if (isLoading) {
         <div class="loading">Loading your bookings...</div>
      } @else {
         <div class="row">
            <div class="col-lg-6">
               <h4>Your Purchased Tickets</h4>
               @if (filteredBookings.length === 0) {
                  <div class="alert alert-info">No bookings found</div>
               }
               <div class="list-group">
                  @for (booking of filteredBookings; track booking.id) {
                     <a class="list-group-item list-group-item-action"
                        [class.active]="selectedBookingId === booking.id"
                        (click)="selectBooking(booking.id)">
                        <div class="d-flex w-100 justify-content-between">
                           <h5 class="mb-1">{{ booking.eventTitle }}</h5>
                           <small class="text-muted">{{ booking.eventDate | date: 'MMM dd, yyyy' }}</small>
                        </div>
                        <p class="mb-1">{{ booking.ticketType }} ‚Äî {{ booking.quantity }} ticket(s)</p>
                        <small class="text-muted">Total: {{ booking.totalPrice | number }}</small>
                     </a>
                  }
               </div>

               <hr />
               <h5>Waitlist Entries</h5>
               @if (waitlistEntries.length === 0) {
                  <div class="text-muted">No waitlist entries</div>
               }
               <ul class="list-group mt-2">
                  @for (w of waitlistEntries; track w.id) {
                     <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                           <div><strong>Event:</strong> {{ (dataEventService.getEventById(w.eventId)?.title) || 'Unknown' }}</div>
                           <div><small>Ticket Type: {{ w.ticketCategoryId }} ‚Ä¢ Qty: {{ w.quantity }}</small></div>
                        </div>
                        <span class="badge bg-secondary">Waitlist</span>
                     </li>
                  }
               </ul>
            </div>

            <div class="col-lg-6">
               <h4>Booking Details</h4>
               @if (!selectedBooking) {
                  <div class="card p-3">Select a booking on the left to view details and QR code.</div>
               }
               @if (selectedBooking && selectedEvent) {
                  <div class="card p-3">
                  <div class="d-flex">
                     <div class="grow">
                        <h5>{{ selectedEvent.title }}</h5>
                        <div><strong>Date:</strong> {{ selectedEvent.date | date: 'fullDate' }}</div>
                        <div><strong>Venue:</strong> {{ selectedEvent.location }}</div>
                        <hr />
                        <div><strong>Booking ID:</strong> {{ selectedBooking.id }}</div>
                        <div><strong>Ticket Type:</strong> {{ selectedTicketType }}</div>
                        <div><strong>Quantity:</strong> {{ selectedBooking.quantity }}</div>
                        <div><strong>Status:</strong> <span class="badge" [class]="getStatusBadgeClass(selectedBooking.status)">{{ selectedBooking.status }}</span></div>
                        <div class="mt-2"><strong>Booked on:</strong> {{ selectedBooking.bookingDate | date:'medium' }}</div>
                     </div>
                      <div class="ms-3">
                        @if (selectedQrDataUrl) {
                           <img [src]="selectedQrDataUrl" alt="QR Code" style="max-width: 260px;" />
                        }
                        @if (!selectedQrDataUrl) {
                           <div class="text-muted">No QR available</div>
                        }
                      </div>
                  </div>

                  <div class="mt-3 d-flex justify-content-between">
                     <div>
                        <button class="btn btn-primary me-2" (click)="downloadTicket(selectedBooking!.id)">üì• Download</button>
                        <button class="btn btn-outline-secondary" (click)="selectBooking('')">Close</button>
                     </div>
                     <div>
                        @if (canCancelSelectedBooking) {
                           <button class="btn btn-danger" (click)="cancelBooking(selectedBooking!.id)">‚ùå Cancel Booking</button>
                        }
                     </div>
                  </div>
                  </div>
               }
            </div>
         </div>
      }
   </div>
</div>
