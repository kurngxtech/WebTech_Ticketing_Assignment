<div class="admin-dashboard">
  <!-- Dashboard Top Bar with Profile and Logout -->
  <div class="dashboard-top-bar">
    <div class="top-bar-content">
      <h1 class="dashboard-title">Admin Dashboard</h1>

      <div class="profile-section">
        @if (currentUser) {
        <div class="profile-info">
          <span class="profile-name">{{ currentUser.fullName }}</span>
          <span class="profile-role">{{ currentUser.role | uppercase }}</span>
        </div>

        <button class="logout-btn" (click)="logout()" title="Logout">
          <app-svg-icon name="logout" [size]="20" color="#feb706"></app-svg-icon>
        </button>
        }
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="dashboard-container">
    <!-- Chart Section -->
    <div class="chart-section">
      <div class="chart-card">
        <!-- Content Wrapper for Blur Effect -->
        <div class="chart-card-content" [class.blur]="showChartOptions">
          <!-- Chart Header with Options -->
          <div class="chart-header">
            <div class="chart-title-area">
              <p class="chart-statement">{{ getStatementText() }}</p>
            </div>
            <button class="menu-button" (click)="toggleChartOptions()" title="Chart options">
              @if (!showChartOptions) {
              <app-svg-icon name="menu-horizontal" [size]="20"></app-svg-icon>
              } @else {
              <app-svg-icon name="close" [size]="20"></app-svg-icon>
              }
            </button>
          </div>

          <!-- Chart Display - Line Chart -->
          <div class="chart-display">
            @if (isLoadingChart) {
            <div class="chart-loading">
              <span class="loading-spinner"></span>
              <p>Loading chart data...</p>
            </div>
            } @else if (chartData.length === 0) {
            <div class="chart-empty">
              <p>No data available for this period</p>
            </div>
            } @else {
            <svg class="line-chart" viewBox="0 0 1000 350" preserveAspectRatio="xMidYMid meet">
              <!-- Grid lines -->
              <g class="grid">
                @for (i of [0,1,2,3,4]; track i) {
                <line
                  [attr.x1]="50"
                  [attr.y1]="i * 60 + 30"
                  [attr.x2]="980"
                  [attr.y2]="i * 60 + 30"
                  class="grid-line"
                />
                }
              </g>
              <!-- Line path -->
              <polyline [attr.points]="getChartLinePoints()" class="chart-line" />
              <!-- Data points with hover -->
              @for (point of chartDataPoints; track $index; let i = $index) {
              <g
                class="data-point-group"
                (mouseenter)="onChartPointHover(chartData[i], $event, i)"
                (mouseleave)="onChartPointLeave()"
              >
                <circle [attr.cx]="point.x" [attr.cy]="point.y" r="8" class="data-point" />
                <circle
                  [attr.cx]="point.x"
                  [attr.cy]="point.y"
                  r="16"
                  class="data-point-hover-area"
                />
              </g>
              }
            </svg>

            <!-- Tooltip - Fixed at top of chart for visibility -->
            @if (hoveredPoint) {
            <div class="chart-tooltip chart-tooltip-fixed" [style.left.px]="tooltipX">
              <div class="tooltip-header">{{ hoveredPoint.label }}</div>
              <div class="tooltip-content">
                <div class="tooltip-row">
                  <span class="tooltip-label"
                    ><app-svg-icon name="ticket" [size]="14"></app-svg-icon> Tickets Sold:</span
                  >
                  <span class="tooltip-value">{{ hoveredPoint.ticketsSold }}</span>
                </div>
                <div class="tooltip-row">
                  <span class="tooltip-label"
                    ><app-svg-icon name="money" [size]="14"></app-svg-icon> Revenue:</span
                  >
                  <span class="tooltip-value">{{ formatPrice(hoveredPoint.revenue) }}</span>
                </div>
                <div class="tooltip-row">
                  <span class="tooltip-label"
                    ><app-svg-icon name="clipboard" [size]="14"></app-svg-icon> Bookings:</span
                  >
                  <span class="tooltip-value">{{ hoveredPoint.bookings }}</span>
                </div>
              </div>
            </div>
            } }
          </div>

          <!-- Time Period Selector with Legend -->
          <div class="time-period-section">
            <button
              class="time-toggle-btn"
              (click)="toggleTimePeriodMenu($event)"
              title="Time period"
            >
              @if (!showTimePeriodMenu) {
              <app-svg-icon name="menu-vertical" [size]="20"></app-svg-icon>
              } @else {
              <app-svg-icon name="close" [size]="20"></app-svg-icon>
              }
            </button>

            @if (showTimePeriodMenu) {
            <div class="time-period-menu">
              <button
                class="time-option"
                [class.active]="selectedTimePeriod === 'daily'"
                (click)="selectTimePeriod('daily')"
              >
                Daily
              </button>
              <button
                class="time-option"
                [class.active]="selectedTimePeriod === 'weekly'"
                (click)="selectTimePeriod('weekly')"
              >
                Weekly
              </button>
              <button
                class="time-option"
                [class.active]="selectedTimePeriod === 'monthly'"
                (click)="selectTimePeriod('monthly')"
              >
                Monthly
              </button>
            </div>
            }

            <!-- Chart Legend (right side) -->
            <div class="chart-legend">
              @for (data of chartData; track $index; let i = $index) {
              <div
                class="legend-item"
                (mouseenter)="onChartPointHover(data, $event, i)"
                (mouseleave)="onChartPointLeave()"
              >
                <span class="legend-dot"></span>
                <span class="legend-label">{{ data.label }}</span>
              </div>
              }
            </div>
          </div>
        </div>

        <!-- Chart Options Overlay - Outside Blurred Content -->
        @if (showChartOptions) {
        <div class="chart-options-overlay">
          <div class="options-group">
            <p class="options-label">Select Data Type:</p>
            <div class="option-buttons">
              <button
                class="option-btn"
                [class.active]="selectedChartType === 'events'"
                (click)="selectChartType('events')"
              >
                Total Events
              </button>
              <button
                class="option-btn"
                [class.active]="selectedChartType === 'tickets'"
                (click)="selectChartType('tickets')"
              >
                Tickets Sold
              </button>
              <button
                class="option-btn"
                [class.active]="selectedChartType === 'revenue'"
                (click)="selectChartType('revenue')"
              >
                Total Revenue
              </button>
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Events Section -->
    <div class="events-section">
      <div class="events-header">
        <h2>All Events</h2>
      </div>

      @if (isLoading) {
      <div class="loading-state">
        <p>Loading all events...</p>
      </div>
      } @else if (allEOEvents.length === 0) {
      <div class="empty-state">
        <p>No events yet.</p>
      </div>
      } @else {
      <div class="events-grid">
        @for (event of allEOEvents; track event.id) {
        <div
          class="event-card"
          [class.blur-card]="expandedEventMenuId === event.id"
          (click)="closeEventMenu()"
        >
          <!-- Event Image -->
          <div class="event-image-section">
            @if (event.img) {
            <img [src]="event.img" [alt]="event.title" class="event-image" />
            } @else {
            <div class="image-placeholder">
              <app-svg-icon name="camera" [size]="48" color="#666"></app-svg-icon>
            </div>
            }
            <div class="event-status-badge" [ngClass]="getStatusBadgeClass(event.status)">
              {{ getStatusText(event.status) }}
            </div>
          </div>

          <!-- Event Content -->
          <div class="event-content">
            <div class="event-header">
              <h3 class="event-title">{{ event.title }}</h3>
              <div class="event-meta">
                <p class="tickets-sold">
                  <strong>Total Tickets Sold:</strong> {{ getTotalTicketsSold(event) }}
                </p>
              </div>
            </div>

            <!-- Event Details -->
            <div class="event-details">
              <div class="detail-item">
                <span class="detail-label"
                  ><app-svg-icon name="location" [size]="14"></app-svg-icon> Location:</span
                >
                <span class="detail-text">{{ event.location }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label"
                  ><app-svg-icon name="calendar" [size]="14"></app-svg-icon> Date:</span
                >
                <span class="detail-text">{{ event.date }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label"
                  ><app-svg-icon name="money" [size]="14"></app-svg-icon> Revenue:</span
                >
                <span class="detail-text">{{ formatPrice(getTotalRevenue(event)) }}</span>
              </div>
            </div>
          </div>

          <!-- Event Menu Button -->
          <div class="event-menu-container">
            <button
              class="event-menu-btn"
              (click)="toggleEventMenu(event.id, $event)"
              title="Event options"
            >
              @if (!expandedEventMenuId || expandedEventMenuId !== event.id) {
              <app-svg-icon name="menu-horizontal" [size]="20"></app-svg-icon>
              } @else {
              <app-svg-icon name="close" [size]="20"></app-svg-icon>
              }
            </button>
          </div>

          <!-- Event Action Menu Overlay - Cover entire card -->
          @if (expandedEventMenuId === event.id) {
          <div class="event-action-overlay" (click)="$event.stopPropagation()">
            <!-- Close Button -->
            <button
              class="overlay-close-btn"
              (click)="toggleEventMenu(event.id, $event)"
              title="Close menu"
            >
              <app-svg-icon name="close" [size]="20"></app-svg-icon>
            </button>

            <div class="action-group">
              <div class="action-buttons" style="grid-template-columns: 1fr">
                <button class="action-item analysis" (click)="viewAnalytics(event)">
                  <app-svg-icon name="chart" [size]="24"></app-svg-icon> In-depth Analysis
                </button>
              </div>
            </div>
          </div>
          }
        </div>
        }
      </div>
      }
    </div>

    <!-- Event Organizers Section -->
    <div class="eos-section">
      <div class="eos-header">
        <h2>Registered Event Organizers</h2>
        <button class="btn btn-primary" (click)="toggleRegistrationForm()" title="Register new EO">
          <span class="btn-icon">+</span>
          Register Event Organizer
        </button>
      </div>

      <!-- Registration Form -->
      @if (showRegistrationForm) {
      <div class="registration-card">
        <h3>Register New Event Organizer</h3>

        @if (registrationMessage) {
        <div
          class="message-box"
          [class.success]="registrationSuccess"
          [class.error]="!registrationSuccess"
        >
          {{ registrationMessage }}
        </div>
        }

        <form [formGroup]="registrationForm" (ngSubmit)="registerEventOrganizer()">
          <div class="form-row">
            <div class="form-group">
              <label>Full Name *</label>
              <input
                type="text"
                class="form-control"
                formControlName="fullName"
                placeholder="e.g., John Doe"
              />
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input
                type="email"
                class="form-control"
                formControlName="email"
                placeholder="e.g., john@example.com"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Phone Number *</label>
              <input
                type="tel"
                class="form-control"
                formControlName="phone"
                placeholder="e.g., 08123456789"
              />
            </div>
            <div class="form-group">
              <label>Organization Name</label>
              <input
                type="text"
                class="form-control"
                formControlName="organizationName"
                placeholder="e.g., ABC Event Company"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Username *</label>
              <input
                type="text"
                class="form-control"
                formControlName="username"
                placeholder="e.g., johndoe"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Password *</label>
              <input
                type="password"
                class="form-control"
                formControlName="password"
                placeholder="Minimum 6 characters"
              />
            </div>
            <div class="form-group">
              <label>Confirm Password *</label>
              <input
                type="password"
                class="form-control"
                formControlName="confirmPassword"
                placeholder="Re-enter password"
              />
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-outline" (click)="toggleRegistrationForm()">
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-success"
              [disabled]="!registrationForm.valid || isSubmitting"
            >
              @if (isSubmitting) {
              <span>Registering...</span>
              } @else {
              <span>Register Event Organizer</span>
              }
            </button>
          </div>
        </form>
      </div>
      }

      <!-- Event Organizers List -->
      @if (registeredEOs.length > 0) {
      <div class="eos-grid">
        @for (eo of registeredEOs; track eo.id) {
        <div class="eo-card">
          <div class="eo-header">
            <div class="eo-avatar">{{ eo.fullName.charAt(0).toUpperCase() }}</div>
            <div class="eo-info">
              <h3 class="eo-name">{{ eo.fullName }}</h3>
              <p class="eo-username">@{{ eo.username }}</p>
            </div>
          </div>

          <div class="eo-details">
            <div class="detail-item">
              <span class="detail-label"
                ><app-svg-icon name="email" [size]="14"></app-svg-icon> Email:</span
              >
              <span class="detail-text">{{ eo.email }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label"
                ><app-svg-icon name="phone" [size]="14"></app-svg-icon> Phone:</span
              >
              <span class="detail-text">{{ eo.phone }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label"
                ><app-svg-icon name="building" [size]="14"></app-svg-icon> Organization:</span
              >
              <span class="detail-text">{{ eo.organizationName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label"
                ><app-svg-icon name="calendar" [size]="14"></app-svg-icon> Registered:</span
              >
              <span class="detail-text">{{ eo.createdAt }}</span>
            </div>
          </div>

          <div class="eo-actions">
            <button
              class="btn btn-danger-small"
              (click)="removeEventOrganizer(eo.id)"
              title="Remove EO"
            >
              <app-svg-icon name="trash" [size]="14"></app-svg-icon> Remove
            </button>
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="empty-state">
        <p>No Event Organizers registered yet.</p>
        <button class="btn btn-primary" (click)="toggleRegistrationForm()">
          Register First Event Organizer
        </button>
      </div>
      }
    </div>
  </div>
</div>
